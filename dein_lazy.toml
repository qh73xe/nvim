# ===========================================
# .config/nvim/dein_lazy.toml
# ===========================================
#
# nvim ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®å†…, éåŒæœŸèª­ã¿è¾¼ã¿ã‚’è¡Œã†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®è¨­å®šã‚’è¨˜è¿°ã—ã¾ã™.

# ====================================================
# LanguageClient
# ====================================================
[[plugins]]
repo = 'neovim/nvim-lspconfig'
on_event = 'FileType'
depends = ['nvim-web-devicons']
lua_source = '''
vim.lsp.handlers["textDocument/publishDiagnostics"] = vim.lsp.with(
  vim.lsp.diagnostic.on_publish_diagnostics, { virtual_text = false }
)
'''

[[plugins]]
repo ='williamboman/mason.nvim'
on_source = 'mason-lspconfig.nvim'
lua_source = '''
require('mason').setup({
  ui = {
    icons = {
      package_installed = "âœ“",
      package_pending = "âœ",
      package_uninstalled = "âœ—"
    }
  }
})
'''

[[plugins]]
repo ='williamboman/mason-lspconfig.nvim'
on_source = 'nvim-lspconfig'
depends = ['nvim-lspconfig']
lua_source = '''
  require("mason-lspconfig").setup({
    ensure_installed = {
      -- docker, docker-compose
      "dockerls",
      "docker_compose_language_service",
      -- react, vue, deno
      "eslint",
      "tsserver",
      "volar",
      "denols",
      -- python
      "pyright",
      "pylsp",
      -- utils
      "lua_ls", -- lua
      "dotls", -- dotfile
      "taplo", -- toml
      "yamlls", -- yaml
      "esbonio", -- rst
      "ltex", -- latex
    },
  })

  local nvim_lsp = require('lspconfig')
  local capabilities = require("ddc_source_lsp").make_client_capabilities()
  require("mason-lspconfig").setup_handlers({
    function(server_name)
      local opts = {
        capabilities = capabilities,
      }
      -- fileType ãŒ rst ã®å ´åˆ LTex ã‚’åˆ©ç”¨ã—ãªã„
      if server_name == "ltex" then
        if vim.bo.filetype == "rst" then
          return
        end
      end

      -- JS é–¢é€£ã® LSP é¸æŠ
      local node_root_dir = nvim_lsp.util.root_pattern("package.json")
      local is_node_repo = node_root_dir(vim.api.nvim_buf_get_name(0)) ~= nil

      local react_root_dir = nvim_lsp.util.root_pattern("main.tsx")
      local is_react_repo = react_root_dir(vim.api.nvim_buf_get_name(0)) ~= nil

      if server_name == "volar" then
        -- package.json é…ä¸‹ã§ãªã‘ã‚Œã°åˆ©ç”¨ã—ãªã„
        if not is_node_repo then
          return
        -- main.tsx é…ä¸‹ã§ã¯åˆ©ç”¨ã—ãªã„
        elseif is_react_repo then
          return
        end
        opts.filetypes = {
          'typescript',
          'javascript',
          'javascriptreact',
          'typescriptreact',
          'vue',
          'json'
        }
      -- App.vue ãŒã‚ã‚‹å ´åˆã«ã¯ tsserver ã®å‡¦ç†ã‚’æ­¢ã‚ã‚‹
      elseif server_name == "tsserver" then
        -- package.json é…ä¸‹ã§ãªã‘ã‚Œã°åˆ©ç”¨ã—ãªã„
       if not is_node_repo then
          return
        -- main.tsx é…ä¸‹ã§ã¯ãªã‘ã‚Œã°åˆ©ç”¨ã—ãªã„
        elseif not is_react_repo then
          return
        end
      elseif server_name == "eslint" then
        -- package.json é…ä¸‹ã§ãªã‘ã‚Œã°åˆ©ç”¨ã—ãªã„
        if not is_node_repo then
          return
        end
      -- package.json é…ä¸‹ã§ã¯åˆ©ç”¨ã—ãªã„
      elseif server_name == "denols" then
        if is_node_repo then
          return
        end
      end
      opts.on_attach = function(_, bufnr)
        local bufopts = { silent = true, buffer = bufnr }

        -- ã‚«ãƒ¼ã‚½ãƒ«ä¸‹ã®å¤‰æ•°ã®æƒ…å ±ã®å–å¾—
        vim.keymap.set('n', 'K', vim.lsp.buf.hover, bufopts)

        -- å®šç¾©ã‚¸ãƒ£ãƒ³ãƒ—
        vim.keymap.set('n', '<C-n>', vim.lsp.buf.definition, bufopts)
        vim.keymap.set('n', '<C-N>', vim.lsp.buf.implementation, bufopts)

        -- å¤‰æ•°å‚ç…§å…ˆã®ä¸€è¦§ã‚’å–å¾—
        vim.keymap.set('n', '<leader>r', vim.lsp.buf.references, bufopts)

        -- Error/Warning/Hint ã®å®Ÿè¡Œå¯èƒ½ãªä¿®æ­£ã®å€™è£œã‚’è¡¨ç¤º
        vim.keymap.set('n', '<leader>h', vim.lsp.buf.code_action, bufopts)

        -- ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®å®Ÿæ–½
        vim.keymap.set('n', '<leader><Enter>', vim.lsp.buf.format, bufopts)

      end
      nvim_lsp[server_name].setup(opts)
    end
  })
'''

[[plugins]] # å‹æƒ…å ±ãƒ˜ãƒ«ãƒ—
repo = 'matsui54/denops-signature_help'
on_event = 'InsertEnter'
depends = ['denops.vim']
hook_source = '''
let g:signature_help_config = {
\ contentsStyle: "full",
\ viewStyle: "floating"
\ }
call signature_help#enable()
'''

# ===================================================
# é–‹ç™ºæ”¯æ´
# ===================================================
[[plugins]] # ã‚·ãƒ³ã‚¿ãƒƒã‚¹ã‚¯ãƒã‚§ãƒƒã‚«ãƒ¼
repo ='folke/trouble.nvim'
on_source = 'nvim-lspconfig'
depends = ['nvim-web-devicons']
lua_source = '''
  require("trouble").setup {
    position = "bottom", -- position of the list can be: bottom, top, left, right
    use_diagnostic_signs = true,
  }
  vim.keymap.set("n", "Q", function() require("trouble").open() end)
'''

[[plugins]] # ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ãƒ¼
repo = 'mhartington/formatter.nvim'
on_event = 'FileType'
lua_source = '''
require("formatter").setup {
  -- ãƒ­ã‚®ãƒ³ã‚°ã‚’æœ‰åŠ¹ã¾ãŸã¯ç„¡åŠ¹ã«ã™ã‚‹
  logging = false,
  filetype = {
    lua = {
      require("formatter.filetypes.lua").stylua
    },
    javascript = {
      require("formatter.filetypes.javascript").prettier
    },
    typescript = {
      require("formatter.filetypes.typescript").prettier,
    },
    typescriptreact = {
      require("formatter.filetypes.typescriptreact").prettier
    },
    vue = {
      require("formatter.filetypes.vue").prettier
    },
    css = {
      require("formatter.filetypes.css").prettier
    },
    python = {
      require("formatter.filetypes.python").yapf,
      require("formatter.filetypes.python").isort
    },
    json = {
      require("formatter.filetypes.json").prettier
    },
    -- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿æ§‹æˆ
    ["*"] = {
      require("formatter.filetypes.any").remove_trailing_whitespace
    }
  }
}
'''

[[plugins]] # LSP ç”¨ã‚¹ãƒ‹ãƒšãƒƒãƒˆè£œå®Œ
repo = 'hrsh7th/vim-vsnip'
on_event = 'InsertEnter'
depends = ['vim-vsnip-integ', 'friendly-snippets']
hook_add = '''
  let g:vsnip_filetypes = {}
'''

[[plugins]] # ã‚¹ãƒ‹ãƒšãƒƒãƒˆè£œå®Œ
repo = 'Shougo/neosnippet'
on_event = 'VimEnter'
on_ft = ['snippet']
depends = ['neosnippet-snippets']
hook_source = '''
  let g:neosnippet#enable_snipmate_compatibility = 1
  let g:neosnippet#snippets_directory=g:ECT_DIR . '/snipets/'
  imap <C-k> <Plug>(neosnippet_expand_or_jump)
  smap <C-k> <Plug>(neosnippet_expand_or_jump)
  xmap <C-k> <Plug>(neosnippet_expand_target)
  if has('conceal')
    set conceallevel=2 concealcursor=niv
  endif
'''

[[plugins]] # copilot
repo = 'github/copilot.vim'
on_event = 'FileType'  # filetype ãŒç‰¹å®šã•ã‚ŒãŸæ™‚ã«èª­ã¿è¾¼ã‚€


# ====================================================
# git
# ====================================================
[[plugins]] # git æ”¯æ´
repo = 'lewis6991/gitsigns.nvim'
on_event = 'VimEnter'
lua_source = '''
require('gitsigns').setup {
  signs = {
    add          = { text = 'â•' },
    change       = { text = 'âœ¨' },
    delete       = { text = 'â–' },
    topdelete    = { text = 'â€¾' },
    changedelete = { text = 'ğŸ”¥' },
    untracked    = { text = 'â”†' },
  },
  signcolumn = true,  -- Toggle with `:Gitsigns toggle_signs`
  numhl      = true, -- Toggle with `:Gitsigns toggle_numhl`
  linehl     = false, -- Toggle with `:Gitsigns toggle_linehl`
  word_diff  = false, -- Toggle with `:Gitsigns toggle_word_diff`
  watch_gitdir = {
    follow_files = true
  },
  attach_to_untracked = true,
  current_line_blame = false, -- Toggle with `:Gitsigns toggle_current_line_blame`
  current_line_blame_opts = {
    virt_text = true,
    virt_text_pos = 'eol', -- 'eol' | 'overlay' | 'right_align'
    delay = 1000,
    ignore_whitespace = false,
  },
  current_line_blame_formatter = '<author>, <author_time:%Y-%m-%d> - <summary>',
  sign_priority = 6,
  update_debounce = 100,
  status_formatter = nil, -- Use default
  max_file_length = 40000, -- Disable if file is longer than this (in lines)
  preview_config = {
    -- Options passed to nvim_open_win
    border = 'single',
    style = 'minimal',
    relative = 'cursor',
    row = 0,
    col = 1
  },
  yadm = {
    enable = false
  },
  on_attach = function(bufnr)
    local gs = package.loaded.gitsigns
    local bufopts = { silent = true, buffer = bufnr }
    -- ã‚«ãƒ¼ã‚½ãƒ«ä¸‹ã®å¤‰æ•°ã®æƒ…å ±ã®å–å¾—
    vim.keymap.set('n', '<leader>hb', function() gs.blame_line{full=false} end, bufopts)
  end
}
'''
